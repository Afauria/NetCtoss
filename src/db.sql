-- 创建数据库
CREATE DATABASE IF NOT EXISTS mydb CHARACTER SET utf8 COLLATE utf8_general_ci ;
USE mydb;
-- 创建数据表
CREATE TABLE IF NOT EXISTS cost(
  	cost_id INT(4) PRIMARY KEY AUTO_INCREMENT,
  	name VARCHAR(50) NOT NULL,
  	base_duration INT(11),-- 基本时长
  	base_cost DOUBLE(7,2),-- 基本费用
  	unit_cost DOUBLE(7,4),-- 单位费用
  	status CHAR(1),-- 状态：0-开通；1-暂停；
  	descr VARCHAR(100),-- //介绍、描述
  	creatime TIMESTAMP DEFAULT CURRENT_TIMESTAMP,-- 创建时间
  	startime TIMESTAMP NULL,-- 开通时间
	cost_type CHAR(1)-- 资费类型：1-包月；2-套餐；3-计时
  )DEFAULT CHARSET=utf8;
-- 插入数据

INSERT INTO COST VALUES (NULL,'5.9元套餐',20,5.9,0.4,0,'5.9元20小时/月,超出部分0.4元/时',DEFAULT,DEFAULT,'2');
INSERT INTO COST VALUES (NULL,'6.9元套餐',40,6.9,0.3,0,'6.9元40小时/月,超出部分0.3元/时',DEFAULT,DEFAULT,'2');
INSERT INTO COST VALUES (NULL,'8.5元套餐',100,8.5,0.2,0,'8.5元100小时/月,超出部分0.2元/时',DEFAULT,DEFAULT,'2');
INSERT INTO COST VALUES (NULL,'10.5元套餐',200,10.5,0.1,0,'10.5元200小时/月,超出部分0.1元/时',DEFAULT,DEFAULT,'2');
INSERT INTO COST VALUES (NULL,'计时收费',NULL,NULL,0.5,0,'0.5元/时,不使用不收费',DEFAULT,DEFAULT,'3');
INSERT INTO COST VALUES (NULL,'包月',NULL,20,NULL,0,'每月20元,不限制使用时间',DEFAULT,DEFAULT,'1');
INSERT INTO COST VALUES (NULL,'计时收费',NULL,20,NULL,1,'每月30元,不限制使用时间',DEFAULT,DEFAULT,'1');






-- 帐务信息表
CREATE TABLE IF NOT EXISTS account(
 	account_id INT(9)  PRIMARY KEY AUTO_INCREMENT,
 	recommender_id INT(9),
 	login_name VARCHAR(30) NOT NULL,
 	login_passwd VARCHAR(30) NOT NULL,
 	status CHAR(1),
 	create_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
 	pause_date TIMESTAMP NULL,
 	close_date TIMESTAMP NULL,
 	real_name VARCHAR(20)NOT NULL,
 	idcard_no CHAR(18)NOT NULL,
 	birthdate DATE,
 	gender CHAR(1),
 	occupation VARCHAR(50),
 	telephone VARCHAR(15) NOT NULL,
 	email VARCHAR(50),
 	mailaddress VARCHAR(200),
 	zipcode CHAR(6),
 	qq VARCHAR(15),
 	last_login_time TIMESTAMP  NULL,
 	last_login_ip VARCHAR(15)
)DEFAULT CHARSET=utf8;


INSERT INTO ACCOUNT(ACCOUNT_ID,RECOMMENDER_ID,LOGIN_NAME,LOGIN_PASSWD,STATUS,CREATE_DATE,
     REAL_NAME,BIRTHDATE,IDCARD_NO,TELEPHONE)
VALUES(1000,NULL,'taiji001','256528','1',DEFAULT,'张三丰','19430225','410381194302256528','13669351234'),
(NULL,NULL,'xl18z60','190613','1',DEFAULT,'郭靖','19690319','330682196903190613',13338924567),
(NULL,1001,'dgbf70','270429','1',DEFAULT,'黄蓉','19710827','330902197108270429',13637811357),
(NULL,1005,'mjjzh64','041115','1',DEFAULT,'张无忌','19890604','610121198906041115',13572952468),
(NULL,1011,'jmdxj00','010322','1',DEFAULT,'杨过','19960101','350581200201010322',18617832562),
(NULL,1011,'ljxj90','310346','1',DEFAULT,'殷离','19930731','320211199307310346',13186454984),
(NULL,NULL,'kxhxd20','012115','1',DEFAULT,'韦小宝','20001001','321022200010012115',13953410078),
(NULL,NULL,'kxhxd21','012116','1',DEFAULT,'魏无羡','20001002','321022200010012116',13953410079),
(NULL,NULL,'kstandi22','012117','1',DEFAULT,'蓝忘机','20001003','321022200010012117',13953410080),
(NULL,NULL,'kxhxd23','012118','1',DEFAULT,'江城','20001004','321022200010012118',13953410081),
(NULL,NULL,'kxhxd24','012119','1',DEFAULT,'史蒂夫','20001005','321022200010012119',13953410082),
(NULL,NULL,'kxhxd25','012120','1',DEFAULT,'奥丁','20001006','321022200010012120',13953410083);




-- 业务信息表
CREATE TABLE IF NOT EXISTS service(
 	service_id INT(10)  PRIMARY KEY AUTO_INCREMENT,
 	account_id INT(9) NOT NULL,
 	unix_host VARCHAR(15) NOT NULL ,
 	os_username VARCHAR(8)	NOT NULL,
 	login_passwd VARCHAR(30) NOT NULL,
 	status CHAR(1),	
 	create_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
 	pause_date TIMESTAMP NULL,
 	close_date TIMESTAMP NULL,
 	cost_id INT(4) NOT NULL
)DEFAULT CHARSET=utf8;



INSERT INTO SERVICE VALUES (NULL,1001,'192.168.0.26','guojing','guo1234','1',DEFAULT,DEFAULT,DEFAULT,1);
INSERT INTO SERVICE VALUES (NULL,1002,'192.168.0.26','huangrong','huang234','1',DEFAULT,DEFAULT,DEFAULT,1);
INSERT INTO SERVICE VALUES (NULL,1003,'192.168.0.20','jinyong','huang234','1',DEFAULT,DEFAULT,DEFAULT,3);
INSERT INTO SERVICE VALUES (NULL,1003,'192.168.0.23','huang234','huang234','1',DEFAULT,DEFAULT,DEFAULT,6);
INSERT INTO SERVICE VALUES (NULL,1003,'192.168.0.26','lumingfei','lu2345','1',DEFAULT,DEFAULT,DEFAULT,4);
INSERT INTO SERVICE VALUES (NULL,1004,'192.168.0.20','luwsh','luwu2345','1',DEFAULT,DEFAULT,DEFAULT,5);
INSERT INTO SERVICE VALUES (NULL,1004,'192.168.0.20','weixb','wei12345','1',DEFAULT,DEFAULT,DEFAULT,6);
INSERT INTO SERVICE VALUES (NULL,1005,'192.168.0.20','guojing','123','1',DEFAULT,DEFAULT,DEFAULT,3);
INSERT INTO SERVICE VALUES (NULL,1005,'192.168.0.30','xiangyu','123','1',DEFAULT,DEFAULT,DEFAULT,2);
INSERT INTO SERVICE VALUES (NULL,1006,'192.168.0.31','luping','123','1',DEFAULT,DEFAULT,DEFAULT,4);
INSERT INTO SERVICE VALUES (NULL,1007,'192.168.0.32','sutang','123','1',DEFAULT,DEFAULT,DEFAULT,5);
INSERT INTO SERVICE VALUES (NULL,1008,'192.168.0.33','qiuci','123','1',DEFAULT,DEFAULT,DEFAULT,1);
INSERT INTO SERVICE VALUES (NULL,1008,'192.168.0.34','xuance','123','1',DEFAULT,DEFAULT,DEFAULT,7);
INSERT INTO SERVICE VALUES (NULL,1008,'192.168.0.35','akiyama','123','1',DEFAULT,DEFAULT,DEFAULT,3);
INSERT INTO SERVICE VALUES (NULL,1009,'192.168.0.36','xanxus','123','1',DEFAULT,DEFAULT,DEFAULT,5);
INSERT INTO SERVICE VALUES (NULL,1009,'192.168.0.37','hunter','123','1',DEFAULT,DEFAULT,DEFAULT,4);
INSERT INTO SERVICE VALUES (NULL,1010,'192.168.0.38','naruto','123','1',DEFAULT,DEFAULT,DEFAULT,5);
INSERT INTO SERVICE VALUES (NULL,1011,'192.168.0.39','zero','123','1',DEFAULT,DEFAULT,DEFAULT,2);
INSERT INTO SERVICE VALUES (NULL,1011,'192.168.0.40','hibe','123','1',DEFAULT,DEFAULT,DEFAULT,2);
INSERT INTO SERVICE VALUES (NULL,1012,'192.168.0.41','yuji','123','1',DEFAULT,DEFAULT,DEFAULT,1);
INSERT INTO SERVICE VALUES (NULL,1012,'192.168.0.42','guanyu','123','1',DEFAULT,DEFAULT,DEFAULT,6);
COMMIT;



-- 业务资费更新备份表
CREATE TABLE IF NOT EXISTS SERVICE_UPDATE_BAK(
 ID INT(10) PRIMARY KEY AUTO_INCREMENT,
 SERVICE_ID INT(9) NOT NULL,
 COST_ID INT(4)  NOT NULL
)DEFAULT CHARSET=utf8;



-- 模块表
CREATE TABLE IF NOT EXISTS module_info(
module_id INT(4)  PRIMARY KEY AUTO_INCREMENT,
module_name VARCHAR(50) NOT NULL
)DEFAULT CHARSET=utf8;

-- 模块表
INSERT INTO MODULE_INFO VALUES(NULL,'角色管理');
INSERT INTO MODULE_INFO VALUES(NULL,'管理员管理');
INSERT INTO MODULE_INFO VALUES(NULL,'资费管理');
INSERT INTO MODULE_INFO VALUES(NULL,'账务账号');
INSERT INTO MODULE_INFO VALUES(NULL,'业务账号');
INSERT INTO MODULE_INFO VALUES(NULL,'账单管理');
INSERT INTO MODULE_INFO VALUES(NULL,'报表');
COMMIT;



-- 角色表
CREATE TABLE IF NOT EXISTS role_info(
 role_id INT(4) PRIMARY KEY AUTO_INCREMENT,
 role_name VARCHAR(50) NOT NULL
)DEFAULT CHARSET=utf8;

-- 角色表
INSERT INTO role_info VALUES(100,'管理员');
INSERT INTO role_info VALUES(null,'营业员');
INSERT INTO role_info VALUES(null,'经理');
INSERT INTO role_info VALUES(null,'aaa');
INSERT INTO role_info VALUES(null,'bbb');
INSERT INTO role_info VALUES(null,'ccc');
COMMIT;

-- 角色模块表
CREATE TABLE role_module(
role_id   INT(4) NOT NULL,
module_id   INT(4) NOT NULL
);

COMMIT;
-- 角色模块表
INSERT INTO role_module VALUES(100,1);
INSERT INTO role_module VALUES(100,2);
INSERT INTO role_module VALUES(101,3);
INSERT INTO role_module VALUES(102,4);
INSERT INTO role_module VALUES(102,5);
INSERT INTO role_module VALUES(103,6);
INSERT INTO role_module VALUES(104,7);
INSERT INTO role_module VALUES(104,3);
INSERT INTO role_module VALUES(104,4);
INSERT INTO role_module VALUES(104,5);
INSERT INTO role_module VALUES(105,5);
INSERT INTO role_module VALUES(105,3);

-- 管理员表,admin_code使用utf8_bin区分大小写
CREATE TABLE IF NOT EXISTS admin_info(
   	admin_id 	INT(8) PRIMARY KEY AUTO_INCREMENT,
   	admin_code 	VARCHAR(30) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
   	password	VARCHAR(30) NOT NULL,
   	admin_name		VARCHAR(30) NOT NULL,
   	telephone 	VARCHAR(15),
   	email 		VARCHAR(50),
   	enrolldate 	TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
)DEFAULT CHARSET=utf8;

-- 管理员表
INSERT INTO admin_info VALUES(2000,'admin','123','ADMIN','123456789','admin@tarena.com.cn',DEFAULT);
INSERT INTO admin_info VALUES(null,'zhangfei','123','ZhangFei','123456789','zhangfei@tarena.com.cn',DEFAULT);
INSERT INTO admin_info VALUES(null,'liubei','123','LiuBei','123456789','liubei@tarena.com.cn',DEFAULT);
INSERT INTO admin_info VALUES(null,'caocao','123','CaoCao','123456789','caocao@tarena.com.cn',DEFAULT);
INSERT INTO admin_info VALUES(null,'aaa','123','AAA','123456789','aaa@tarena.com.cn',DEFAULT);
INSERT INTO admin_info VALUES(null,'bbb','123','BBB','123456789','bbb@tarena.com.cn',DEFAULT);
COMMIT;



-- 管理员角色表
CREATE TABLE IF NOT EXISTS admin_role(
admin_id INT(8) NOT NULL,
role_id INT(4) NOT NULL
)DEFAULT CHARSET=utf8;
-- 管理员角色表
INSERT INTO admin_role VALUES(2000,100);
INSERT INTO admin_role VALUES(2001,101);
INSERT INTO admin_role VALUES(2002,103);
INSERT INTO admin_role VALUES(2003,100);
INSERT INTO admin_role VALUES(2003,101);
INSERT INTO admin_role VALUES(2003,102);
COMMIT;

create table if not exists bill(
bill_id int(8) PRIMARY KEY AUTO_INCREMENT,
account_id int(8) not null,
bill_fee float,
bill_month TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
pay_mode varchar(10),
pay_status char(1)
)default CHARSET=utf8;

insert into bill(account_id,bill_fee,bill_month,pay_mode,pay_status)
values(1000,543.45,default,'现金','1'),
(1011,843.00,default,null,'0'),
(1003,12.00,default,'支付宝','1'),
(1003,543.45,default,null,'0'),
(1005,12.00,default,'支付宝','1'),
(1007,543.45,default,'支付宝','1'),
(1007,240.45,default,null,'0');

create table if not exists record_info(
record_id int(8) PRIMARY KEY AUTO_INCREMENT,
service_id int(8) not null,
login_time TIMESTAMP null,
logout_time TIMESTAMP null,
duration int(8),
fee float
)default CHARSET=utf8;

DELIMITER $$
CREATE TRIGGER cal_duration before INSERT
ON record_info FOR EACH ROW
BEGIN
  set new.duration=UNIX_TIMESTAMP(new.logout_time)-UNIX_TIMESTAMP(new.login_time);
  if new.duration<0 then
    delete from record_info where record_id=new.record_id;
  end if;
END $$
DELIMITER ;


insert into record_info(service_id,login_time,logout_time,fee)
values(3,'20180911140000','20180911140311',0.25),
(2,'20180911140000','20180911140011',0.45),
(3,'20180911140000','20180911140100',0.88),
(1,'20180911140000','20180911140400',0.25),
(3,'20180911140000','20180911140011',0.45),
(3,'20180911140000','20180911140100',0.88),
(3,'20180911140000','20180911140400',0.25),
(2,'20180911140000','20180911140011',0.45),
(3,'20180911140000','20180911140120',0.88),
(1,'20180911140000','20180911140400',0.25),
(2,'20180911140000','20180911140011',0.45),
(3,'20180911140000','20180911140150',0.88),
(1,'20180911140000','20180911141400',0.25),
(2,'20180911140000','20180911140011',0.45),
(3,'20180911140000','20180911141100',0.88),
(1,'20180911140000','20180911140405',0.25),
(2,'20180911140000','20180911140031',0.45),
(3,'20180911140000','20180911140100',0.88),
(1,'20180911140000','20180911142409',0.25),
(2,'20180911140000','20180911140011',0.45),
(3,'20180911140000','20180911140100',0.88),
(1,'20180911140000','20180911140404',0.25),
(2,'20180911140000','20180911140021',0.45),
(3,'20180911140000','20180911140300',0.88),
(1,'20180911140000','20180911140420',0.25);


-- delimiter $$
-- create event cost_per_month
-- on schedule every 10 second starts now()
-- do
-- begin
--     start transaction;
--       declare f_parent,entityId  int;
--       declare b int default 0;    /*是否达到记录的末尾控制变量*/
--       declare f_name varchar(100);
--       DECLARE cur_1 CURSOR FOR select account_id from account;
--       DECLARE CONTINUE HANDLER FOR NOT FOUND SET b = 1;
--       OPEN cur_1;
--       FETCH cur_1 INTO _account_id; /*获取第一条记录*/
--       while b<>1 do
--           insert into bill(account_id,bill_fee,bill_month) values(_account_id);
--           FETCH cur_1 INTO _account_id; /*取下一条记录*/
--       end while;
--       close cur_1;
--     commit;  #提交事务
-- end  $$
-- delimiter ;


